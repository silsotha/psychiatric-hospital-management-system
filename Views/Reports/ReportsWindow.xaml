<Window x:Class="PsychiatricHospitalWPF.Views.Reports.ReportsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="Отчёты и статистика" 
        Height="750" Width="1100"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- шапка -->
        <Border Grid.Row="0" Background="#FF9800" Padding="15">
            <TextBlock Text="📊 Отчёты и статистика" 
                      FontSize="18" 
                      FontWeight="Bold" 
                      Foreground="White"/>
        </Border>

        <!-- панель управления -->
        <Border Grid.Row="1" Background="#f5f5f5" Padding="15" BorderBrush="#ddd" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- общая статистика -->
                <Border Grid.Row="0" 
                       Background="#E8F5E9" 
                       BorderBrush="#4CAF50" 
                       BorderThickness="1"
                       Padding="15"
                       Margin="0,0,0,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="👥 Текущие пациенты" 
                                      FontSize="11" 
                                      Foreground="Gray"/>
                            <TextBlock x:Name="txtCurrentPatients" 
                                      Text="0" 
                                      FontSize="24" 
                                      FontWeight="Bold"
                                      Foreground="#2E7D32"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="🛏️ Загрузка коек" 
                                      FontSize="11" 
                                      Foreground="Gray"/>
                            <TextBlock x:Name="txtOccupancy" 
                                      Text="0/0 (0%)" 
                                      FontSize="18" 
                                      FontWeight="SemiBold"
                                      Foreground="#1976D2"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="📤 Всего выписано" 
                                      FontSize="11" 
                                      Foreground="Gray"/>
                            <TextBlock x:Name="txtTotalDischarged" 
                                      Text="0" 
                                      FontSize="20" 
                                      FontWeight="SemiBold"/>
                        </StackPanel>

                        <StackPanel Grid.Column="3">
                            <TextBlock Text="💊 Активные назначения" 
                                      FontSize="11" 
                                      Foreground="Gray"/>
                            <TextBlock x:Name="txtActivePrescriptions" 
                                      Text="0" 
                                      FontSize="20" 
                                      FontWeight="SemiBold"
                                      Foreground="#9C27B0"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- выбор типа отчёта -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <Label Content="Тип отчёта:" 
                          Grid.Column="0"
                          VerticalAlignment="Center"
                          FontWeight="SemiBold"/>

                    <ComboBox x:Name="cmbReportType" 
                             Grid.Column="1"
                             Height="35"
                             Margin="10,0"
                             Padding="8"
                             SelectionChanged="CmbReportType_SelectionChanged">
                        <ComboBoxItem Content="👥 Текущие пациенты" IsSelected="True"/>
                        <ComboBoxItem Content="🛏️ Загрузка палат и отделений"/>
                        <ComboBoxItem Content="📋 Статистика по диагнозам"/>
                    </ComboBox>

                    <Button x:Name="btnPrint" 
                           Content="📄 Создать PDF" 
                           Grid.Column="2"
                           Click="BtnPrint_Click"
                           Background="#2196F3"
                           Foreground="White"
                           Padding="15,6"
                           Cursor="Hand"/>
                </Grid>
            </Grid>
        </Border>

        <!-- контейнер для отчётов -->
        <Grid Grid.Row="2">
            <!-- отчёт: текущие пациенты -->
            <DataGrid x:Name="dgCurrentPatients" 
                     AutoGenerateColumns="False"
                     IsReadOnly="True"
                     RowHeight="35"
                     AlternatingRowBackground="#f9f9f9">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="№ Карты" Binding="{Binding CardNumber}" Width="100"/>
                    <DataGridTextColumn Header="ФИО" Binding="{Binding FullName}" Width="180"/>
                    <DataGridTextColumn Header="Возраст" Binding="{Binding Age}" Width="70"/>
                    <DataGridTextColumn Header="Диагноз" Binding="{Binding Diagnosis}" Width="*"/>
                    <DataGridTextColumn Header="Дата поступления" Binding="{Binding AdmissionDateDisplay}" Width="120"/>
                    <DataGridTextColumn Header="Дней в больнице" Binding="{Binding DaysInHospitalDisplay}" Width="120"/>
                    <DataGridTextColumn Header="Палата" Binding="{Binding WardNumber}" Width="80"/>
                    <DataGridTextColumn Header="Отделение" Binding="{Binding Department}" Width="150"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- отчёт: загрузка палат -->
            <DataGrid x:Name="dgWardOccupancy" 
                     AutoGenerateColumns="False"
                     IsReadOnly="True"
                     RowHeight="40"
                     AlternatingRowBackground="#f9f9f9"
                     Visibility="Collapsed">
                <DataGrid.Columns>
                    <!-- индикатор статуса -->
                    <DataGridTemplateColumn Header="Статус" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <!-- цветной кружок -->
                                    <Ellipse Width="20" 
                                            Height="20" 
                                            Fill="{Binding StatusBrush, Mode=OneWay}"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            ToolTip="{Binding StatusText, Mode=OneWay}"/>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Отделение" Binding="{Binding Department}" Width="200"/>
                    <DataGridTextColumn Header="Палата" Binding="{Binding WardNumber}" Width="100"/>
                    <DataGridTextColumn Header="Всего мест" Binding="{Binding TotalBeds}" Width="100"/>
                    <DataGridTextColumn Header="Занято" Binding="{Binding OccupiedBeds}" Width="80"/>
                    <DataGridTextColumn Header="Свободно" Binding="{Binding AvailableBeds}" Width="80"/>

                    <!-- прогресс-бар с процентом -->
                    <DataGridTemplateColumn Header="Загрузка" Width="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid Margin="5,0">
                                    <ProgressBar Value="{Binding OccupancyRate, Mode=OneWay}" 
                                               Minimum="0" 
                                               Maximum="100"
                                               Height="22"
                                               Foreground="{Binding StatusBrush, Mode=OneWay}"/>
                                    <TextBlock Text="{Binding OccupancyDisplay, Mode=OneWay}" 
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              FontWeight="SemiBold"
                                              Foreground="White"/>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- текстовый статус -->
                    <DataGridTemplateColumn Header="Состояние" Width="150">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding StatusText, Mode=OneWay}" 
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          FontWeight="SemiBold"
                                          Foreground="{Binding StatusBrush, Mode=OneWay}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <!-- отчёт: статистика по диагнозам -->
            <Grid x:Name="gridDiagnosisStats" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- фильтр по датам -->
                <Border Grid.Row="0" Background="#f9f9f9" Padding="10" BorderBrush="#ddd" BorderThickness="0,0,0,1">
                    <StackPanel Orientation="Horizontal">
                        <Label Content="Период:" VerticalAlignment="Center"/>
                        <DatePicker x:Name="dpDiagFrom" Width="120" Height="30" Margin="5,0"/>
                        <TextBlock Text="—" VerticalAlignment="Center" Margin="5,0"/>
                        <DatePicker x:Name="dpDiagTo" Width="120" Height="30" Margin="5,0"/>
                        <Button x:Name="btnApplyDiagFilter" 
                               Content="Применить" 
                               Click="BtnApplyDiagFilter_Click"
                               Padding="10,5"
                               Margin="10,0,5,0"
                               Cursor="Hand"/>
                        <Button x:Name="btnResetDiagFilter" 
                               Content="🔄 Сбросить" 
                               Click="BtnResetDiagFilter_Click"
                               Padding="10,5"
                               Margin="0"
                               Cursor="Hand"
                               Background="#9E9E9E"
                               Foreground="White"/>
                    </StackPanel>
                </Border>

                <DataGrid x:Name="dgDiagnosisStats" 
                         Grid.Row="1"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         RowHeight="35"
                         AlternatingRowBackground="#f9f9f9">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Диагноз" Binding="{Binding Diagnosis}" Width="*"/>
                        <DataGridTextColumn Header="Количество пациентов" Binding="{Binding PatientCount}" Width="180"/>
                        <DataGridTextColumn Header="Средняя длительность" Binding="{Binding AverageDurationDisplay}" Width="180"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <!-- строка состояния -->
        <Border Grid.Row="3" Background="#f5f5f5" Padding="10" BorderBrush="#ddd" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- легенда цветов (для отчёта загрузки палат) -->
                <StackPanel x:Name="pnlLegend" 
                           Grid.Column="0"
                           Orientation="Horizontal" 
                           Visibility="Collapsed">
                    <TextBlock Text="Легенда:" 
                              FontWeight="SemiBold" 
                              Margin="0,0,10,0"
                              VerticalAlignment="Center"/>

                    <!-- зелёный: < 50% -->
                    <Ellipse Width="16" Height="16" Fill="#4CAF50" Margin="5,0"/>
                    <TextBlock Text="Есть места (&lt;50%)" Margin="0,0,12,0" VerticalAlignment="Center"/>

                    <!-- жёлтый: 50-79% -->
                    <Ellipse Width="16" Height="16" Fill="#FFC107" Margin="5,0"/>
                    <TextBlock Text="Заполнена наполовину (50-79%)" Margin="0,0,12,0" VerticalAlignment="Center"/>

                    <!-- оранжевый: 80-99% -->
                    <Ellipse Width="16" Height="16" Fill="#FF9800" Margin="5,0"/>
                    <TextBlock Text="Почти полная (≥80%)" Margin="0,0,12,0" VerticalAlignment="Center"/>

                    <!-- красный: 100% -->
                    <Ellipse Width="16" Height="16" Fill="#f44336" Margin="5,0"/>
                    <TextBlock Text="Полностью занята" Margin="0,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <TextBlock x:Name="lblStatus" 
                          Grid.Column="1"
                          Text="Готово" 
                          FontSize="12"
                          VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</Window>
